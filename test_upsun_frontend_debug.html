<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upsun Frontend API Debug</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .test-section {
      border: 1px solid #ddd;
      margin: 10px 0;
      padding: 15px;
      border-radius: 5px;
    }

    .success {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    .error {
      background: #f8d7da;
      border-color: #f5c6cb;
    }

    .info {
      background: #d1ecf1;
      border-color: #bee5eb;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
    }

    input {
      padding: 8px;
      margin: 5px;
      width: 200px;
    }
  </style>
</head>

<body>
  <h1>ðŸ”§ Upsun Frontend API Debug Tool</h1>

  <div class="test-section info">
    <h3>Environment Information</h3>
    <pre id="env-info"></pre>
  </div>

  <div class="test-section">
    <h3>API URL Test</h3>
    <button onclick="testApiUrl()">Test API URL Detection</button>
    <pre id="api-url-result"></pre>
  </div>

  <div class="test-section">
    <h3>CORS Test</h3>
    <button onclick="testCors()">Test CORS Headers</button>
    <pre id="cors-result"></pre>
  </div>

  <div class="test-section">
    <h3>Login API Test</h3>
    <input type="text" id="username" placeholder="Username" value="admin">
    <input type="password" id="password" placeholder="Password" value="admin123">
    <button onclick="testLogin()">Test Login API</button>
    <pre id="login-result"></pre>
  </div>

  <div class="test-section">
    <h3>Raw Response Test</h3>
    <button onclick="testRawResponse()">Get Raw Login Response</button>
    <pre id="raw-result"></pre>
  </div>

  <script>
    // Display environment information
    function displayEnvInfo() {
      const info = {
        hostname: window.location.hostname,
        protocol: window.location.protocol,
        port: window.location.port,
        pathname: window.location.pathname,
        origin: window.location.origin,
        userAgent: navigator.userAgent.substring(0, 100) + '...'
      };
      document.getElementById('env-info').textContent = JSON.stringify(info, null, 2);
    }

    // Test API URL detection
    function testApiUrl() {
      const result = document.getElementById('api-url-result');

      try {
        // Simulate the frontend API URL detection logic
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;

        let apiUrl;
        if (hostname.includes('upsun-deployment') || hostname.includes('.platformsh.site')) {
          // For Upsun: frontend is on {default}, backend is on api.{default}
          let apiHostname = hostname;

          // If we're NOT already on the api subdomain, add it
          if (!hostname.startsWith('api.')) {
            apiHostname = `api.${hostname}`;
          }

          apiUrl = `${protocol}//${apiHostname}`;
        } else {
          apiUrl = `${protocol}//${hostname}`;
        }

        const loginEndpoint = `${apiUrl}/api/users/login/`;

        const testResult = {
          currentHostname: hostname,
          protocol,
          apiHostname: apiUrl.replace(protocol + '//', ''),
          detectedApiUrl: apiUrl,
          loginEndpoint,
          isUpsun: hostname.includes('upsun-deployment') || hostname.includes('.platformsh.site'),
          hostnameStartsWithApi: hostname.startsWith('api.'),
          explanation: hostname.includes('upsun-deployment') ?
            'Upsun detected: Frontend on {default}, Backend on api.{default}' :
            'Standard deployment: Same domain'
        };

        result.textContent = JSON.stringify(testResult, null, 2);
        result.parentElement.className = 'test-section success';
      } catch (error) {
        result.textContent = `Error: ${error.message}`;
        result.parentElement.className = 'test-section error';
      }
    }

    // Test CORS
    async function testCors() {
      const result = document.getElementById('cors-result');

      try {
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;

        // Use same logic as API URL detection
        let apiUrl;
        if (hostname.includes('upsun-deployment') || hostname.includes('.platformsh.site')) {
          let apiHostname = hostname;
          if (!hostname.startsWith('api.')) {
            apiHostname = `api.${hostname}`;
          }
          apiUrl = `${protocol}//${apiHostname}`;
        } else {
          apiUrl = `${protocol}//${hostname}`;
        }

        const response = await fetch(`${apiUrl}/api/users/login/`, {
          method: 'OPTIONS',
          headers: {
            'Origin': window.location.origin,
            'Access-Control-Request-Method': 'POST',
            'Access-Control-Request-Headers': 'Content-Type'
          }
        });

        const corsHeaders = {
          testUrl: `${apiUrl}/api/users/login/`,
          status: response.status,
          statusText: response.statusText,
          'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
          'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
          'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
          'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
        };

        result.textContent = JSON.stringify(corsHeaders, null, 2);
        result.parentElement.className = response.status === 200 ? 'test-section success' : 'test-section error';
      } catch (error) {
        result.textContent = `CORS Error: ${error.message}`;
        result.parentElement.className = 'test-section error';
      }
    }

    // Test login API
    async function testLogin() {
      const result = document.getElementById('login-result');
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;

        // Use same logic as API URL detection
        let apiUrl;
        if (hostname.includes('upsun-deployment') || hostname.includes('.platformsh.site')) {
          let apiHostname = hostname;
          if (!hostname.startsWith('api.')) {
            apiHostname = `api.${hostname}`;
          }
          apiUrl = `${protocol}//${apiHostname}`;
        } else {
          apiUrl = `${protocol}//${hostname}`;
        }

        const loginUrl = `${apiUrl}/api/users/login/`;

        console.log('ðŸš€ Testing login with URL:', loginUrl);

        const response = await fetch(loginUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ username, password }),
          mode: 'cors',
          credentials: 'omit'
        });

        console.log('ðŸ“¥ Response received:', response);

        const responseText = await response.text();
        console.log('ðŸ“„ Response text:', responseText);

        let parsedData;
        try {
          parsedData = JSON.parse(responseText);
        } catch (parseError) {
          parsedData = { parseError: parseError.message, rawText: responseText };
        }

        const testResult = {
          url: loginUrl,
          frontendDomain: window.location.origin,
          backendDomain: apiUrl,
          status: response.status,
          statusText: response.statusText,
          headers: Object.fromEntries(response.headers.entries()),
          contentType: response.headers.get('content-type'),
          responseText: responseText.substring(0, 500) + (responseText.length > 500 ? '...' : ''),
          parsedData: parsedData
        };

        result.textContent = JSON.stringify(testResult, null, 2);
        result.parentElement.className = response.status === 200 ? 'test-section success' : 'test-section error';
      } catch (error) {
        result.textContent = `Login Test Error: ${error.message}\nStack: ${error.stack}`;
        result.parentElement.className = 'test-section error';
      }
    }

    // Test raw response
    async function testRawResponse() {
      const result = document.getElementById('raw-result');

      try {
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        const apiUrl = `${protocol}//${hostname}`;
        const loginUrl = `${apiUrl}/api/users/login/`;

        // Just try to fetch the endpoint without any data
        const response = await fetch(loginUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          },
          mode: 'cors',
          credentials: 'omit'
        });

        const responseText = await response.text();

        const rawResult = {
          url: loginUrl,
          method: 'GET',
          status: response.status,
          statusText: response.statusText,
          contentType: response.headers.get('content-type'),
          contentLength: response.headers.get('content-length'),
          responseText: responseText
        };

        result.textContent = JSON.stringify(rawResult, null, 2);
        result.parentElement.className = 'test-section info';
      } catch (error) {
        result.textContent = `Raw Response Error: ${error.message}`;
        result.parentElement.className = 'test-section error';
      }
    }

    // Initialize
    displayEnvInfo();
    testApiUrl();
  </script>
</body>

</html>
