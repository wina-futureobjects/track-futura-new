<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Futura - Upsun Frontend Debug</title>
  <style>
    body {
      font-family: monospace;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }

    .test-section {
      border: 1px solid #333;
      margin: 10px 0;
      padding: 15px;
      background: #2a2a2a;
    }

    .success {
      color: #00ff00;
    }

    .error {
      color: #ff4444;
    }

    .warning {
      color: #ffaa00;
    }

    pre {
      background: #1a1a1a;
      padding: 10px;
      border: 1px solid #333;
      overflow-x: auto;
    }

    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border-radius: 4px;
    }

    button:hover {
      background: #0066aa;
    }

    input {
      background: #333;
      color: white;
      border: 1px solid #555;
      padding: 8px;
      margin: 5px;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <h1>üöÄ Track Futura - Upsun Frontend Debug Tool</h1>

  <div class="test-section">
    <h2>üìç Environment Detection</h2>
    <div id="environment-info"></div>
  </div>

  <div class="test-section">
    <h2>üîó API URL Detection</h2>
    <div id="api-url-info"></div>
  </div>

  <div class="test-section">
    <h2>üß™ Login API Test</h2>
    <input type="text" id="username" placeholder="Username" value="tenantadmin">
    <input type="password" id="password" placeholder="Password" value="">
    <button onclick="testLogin()">Test Login</button>
    <div id="login-result"></div>
  </div>

  <div class="test-section">
    <h2>üìä Test Results</h2>
    <div id="test-results"></div>
  </div>

  <script>
    // Simulate Vite environment variables
    const importMeta = {
      env: {
        PROD: true,  // This is what should be true in production
        DEV: false,
        MODE: 'production'
      }
    };

    // Mock getApiBaseUrl function based on your latest code
    function getApiBaseUrl() {
      // Check if there's a global API base URL
      if (typeof window !== 'undefined' && window.API_BASE_URL !== undefined) {
        console.log('üåê Using global API_BASE_URL:', window.API_BASE_URL);
        return window.API_BASE_URL;
      }

      // Get environment info
      const hostname = window.location.hostname;
      const protocol = window.location.protocol;
      const isProd = importMeta.env.PROD;
      const isDev = importMeta.env.DEV;
      const mode = importMeta.env.MODE;

      console.log('üîç DETAILED Environment Detection:', {
        hostname,
        protocol,
        isProd,
        isDev,
        mode,
        'import.meta.env': importMeta.env,
        'window.location': window.location
      });

      // Production logic
      if (isProd) {
        console.log('‚úÖ Production mode detected');

        console.log('üîç Hostname checks:', {
          hostname,
          'includes upsun-deployment': hostname.includes('upsun-deployment'),
          'includes .platformsh.site': hostname.includes('.platformsh.site'),
          'starts with api.': hostname.startsWith('api.')
        });

        // Upsun deployment check
        if (hostname.includes('upsun-deployment') || hostname.includes('.platformsh.site')) {
          console.log('üéØ Upsun domain detected!');

          let apiHostname = hostname;
          if (!hostname.startsWith('api.')) {
            apiHostname = `api.${hostname}`;
            console.log('üìç Adding api subdomain:', { original: hostname, modified: apiHostname });
          } else {
            console.log('üìç Already on api subdomain:', hostname);
          }

          const apiUrl = `${protocol}//${apiHostname}`;
          console.log('‚úÖ Using Upsun API URL (with api subdomain):', apiUrl);
          return apiUrl;
        }

        // Other production environments
        console.log('üåê Non-Upsun production environment detected');
        const apiUrl = `${protocol}//${hostname}`;
        console.log('‚úÖ Using production API URL:', apiUrl);
        return apiUrl;
      }

      console.log('üõ†Ô∏è Development mode detected');
      return 'http://localhost:8000';
    }

    function createApiUrl(endpoint) {
      const baseUrl = getApiBaseUrl();
      const formattedEndpoint = endpoint.startsWith('/api/') ? endpoint : `/api/${endpoint.replace(/^\//, '')}`;
      const fullUrl = `${baseUrl}${formattedEndpoint}`;
      console.log('üîó API URL Created:', { endpoint, baseUrl, fullUrl });
      return fullUrl;
    }

    // Display environment info
    function displayEnvironmentInfo() {
      const info = {
        hostname: window.location.hostname,
        protocol: window.location.protocol,
        port: window.location.port,
        origin: window.location.origin,
        href: window.location.href,
        isProd: importMeta.env.PROD,
        isDev: importMeta.env.DEV,
        mode: importMeta.env.MODE
      };

      document.getElementById('environment-info').innerHTML = `
        <pre>${JSON.stringify(info, null, 2)}</pre>
      `;
    }

    // Display API URL info
    function displayApiUrlInfo() {
      console.clear();
      const baseUrl = getApiBaseUrl();
      const loginUrl = createApiUrl('/users/login/');

      const info = {
        baseUrl,
        loginUrl,
        'Expected for Upsun': `https://api.${window.location.hostname}/api/users/login/`
      };

      document.getElementById('api-url-info').innerHTML = `
        <pre>${JSON.stringify(info, null, 2)}</pre>
      `;
    }

    // Test login function
    async function testLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const resultDiv = document.getElementById('login-result');

      if (!password) {
        resultDiv.innerHTML = '<div class="error">Please enter a password</div>';
        return;
      }

      try {
        const url = createApiUrl('/users/login/');
        console.log('üöÄ Testing login with URL:', url);

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ username, password }),
          mode: 'cors',
          credentials: 'omit'
        });

        console.log('üì• Response:', {
          status: response.status,
          statusText: response.statusText,
          contentType: response.headers.get('content-type'),
          url: response.url
        });

        const text = await response.text();
        console.log('üìÑ Response text:', text);

        let result = `
          <h3>Response Details:</h3>
          <pre>Status: ${response.status}
Content-Type: ${response.headers.get('content-type')}
URL: ${response.url}

Response Body:
${text}</pre>
        `;

        if (response.status === 200) {
          try {
            const json = JSON.parse(text);
            result += `<div class="success">‚úÖ Success! Got JSON response</div>`;
          } catch (e) {
            result += `<div class="error">‚ùå Got 200 but response is not JSON (likely HTML from frontend)</div>`;
          }
        } else {
          result += `<div class="error">‚ùå HTTP Error: ${response.status}</div>`;
        }

        resultDiv.innerHTML = result;

      } catch (error) {
        console.error('‚ùå Login test failed:', error);
        resultDiv.innerHTML = `<div class="error">‚ùå Network Error: ${error.message}</div>`;
      }
    }

    // Initialize
    window.onload = function () {
      displayEnvironmentInfo();
      displayApiUrlInfo();
    };
  </script>
</body>

</html>
