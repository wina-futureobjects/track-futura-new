# TrackFutura deployment with integrated React frontend - Force rebuild v3
applications:
  trackfutura:
    type: python:3.12
    
    dependencies:
      python3:
        pip: ">=23.0"
      nodejs:
        npm: "10"
    
    build:
      flavor: none
    
    web:
      commands:
        start: "cd backend && gunicorn config.wsgi:application --bind 0.0.0.0:$PORT"
    
    hooks:
      build: |
        set -e
        
        echo "=== BUILDING TRACKFUTURA FRONTEND + BACKEND ==="
        echo "Current directory: $(pwd)"
        echo "Listing files: $(ls -la)"
        
        echo "=== Step 1: Build React Frontend ==="
        cd frontend
        echo "Frontend directory contents: $(ls -la)"
        npm ci --production=false
        npm run build
        echo "Frontend build completed, dist contents: $(ls -la dist/)"
        cd ..
        
        echo "=== Step 2: Install Python Dependencies ==="
        cd backend
        pip install -r requirements.txt
        cd ..
        
        echo "=== Step 3: Copy Frontend to Django Static ==="
        mkdir -p backend/staticfiles/
        cp -r frontend/dist/* backend/staticfiles/
        echo "Copied frontend files to staticfiles: $(ls -la backend/staticfiles/)"
        
        echo "=== Step 4: Collect Django Static Files ==="
        cd backend
        python manage.py collectstatic --noinput --clear
        echo "Static files collection completed"
        
        echo "=== BUILD COMPLETED SUCCESSFULLY ==="
      
      deploy: |
        cd backend
        python manage.py migrate --noinput
    
    relationships:
      database: postgresql:postgresql

services:
  postgresql:
    type: postgresql:15

routes:
  "https://{default}/":
    type: upstream
    upstream: "trackfutura:http"
